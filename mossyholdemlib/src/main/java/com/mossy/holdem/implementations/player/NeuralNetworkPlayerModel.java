package com.mossy.holdem.implementations.player;

import com.google.common.base.Function;
import com.google.common.collect.FluentIterable;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;
import com.google.inject.Inject;
import com.googlecode.fannj.Fann;
import com.mossy.holdem.Card;
import com.mossy.holdem.ProbabilityTriple;
import com.mossy.holdem.Rank;
import com.mossy.holdem.Suit;
import com.mossy.holdem.interfaces.player.IPlayerModel;
import com.mossy.holdem.interfaces.player.IPlayerState;
import com.mossy.holdem.interfaces.player.IPlayerStatistics;
import com.mossy.holdem.interfaces.player.IPlayerStatisticsHolder;
import com.mossy.holdem.interfaces.state.IGameState;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.encog.ml.MLEncodable;
import org.encog.ml.MLInput;
import org.encog.ml.MLMethod;
import org.encog.ml.data.MLData;
import org.encog.ml.data.basic.BasicMLData;
import org.encog.ml.factory.MLMethodFactory;
import org.encog.neural.networks.BasicNetwork;
import org.encog.persist.EncogDirectoryPersistence;

import java.util.Collections;

/**
 * Created by willrubens on 13/06/15.
 */



public class NeuralNetworkPlayerModel implements IPlayerModel {
    //Fann myNeuralNetwork;

        final static private Logger log = LogManager.getLogger(NeuralNetworkPlayerModel.class);

// Code generated by Encog v3.2.0
// Generation Date: Sun Aug 09 14:59:36 BST 2015
// Generated code may be used freely
// http://www.heatonresearch.com/encog

    public static final double[] WEIGHTS = {
            0.9953946067, 0.4344802778, 0.7795311102, 0.6056967983, 1.0635814934, 1.1105277306, 1.0399532197, 1.4578099756, 0.6794063811, 0.62704257,
            -1.5273627027, 1.1622098202, 1.2156420967, 0.5395960891, 1.0989046724, 0.4667417593, 0.2053008956, 1.2734504338, 0.2102667612, 1.3362181645,
            0.0006417873, -0.3888424417, 0.2091758262, 0.884154054, 0.9535890334, 0.9019845468, 0.1629272829, 0.403835696, 1.2030618727, 0.0680454344,
            0.7033046048, 1.1756181801, -1.0499401847, 0.9567840998, 1.5077627074, 0.0452632424, 1.0639471962, 0.6022525906, 0.1172577271, 0.6101448333,
            0.5547493933, 0.0176021073, 0.8643710969, 0.7203934507, 1.0082825452, 0.4347117348, 0.4074397984, 0.1319471784, 0.5149096338, 0.0839984505,
            0.937828687, 0.4973796929, 1.3564525728, 0.2222584529, 0.1553387348, 0.0787485983, 0.622272679, 0.544759245, 1.1134223106, 0.7676378394,
            0.1155668376, 1.188489541, 0.5533446442, 0.5480684472, 0.9841500012, 0.6396326945, 0.5493952475, 0.0218066995, 0.1567794198, 1.2752647078,
            1.4494987273, 1.1333246553, 1.4277491017, 1.1790177392, 0.7411114413, 0.5771014987, 1.467465267, 1.3480426498, 0.7314812272, 1.2443003876,
            0.6173513391, 0.9817042461, 0.9468805938, 1.0721845354, 1.0881348873, 0.3353008732, 0.5583008383, 1.3946218451, 1.0168137805, 0.7441737621,
            0.1809961991, 0.3868658853, 0.9289527502, 1.2746207879, -0.1737405987, 1.3722370268, 0.4293145206, 0.2225567825, 0.2055524973, 1.2297393577,
            1.3633683102, 0.7303273118, 0.4327324901, 1.3807937034, 1.1097922078, 0.6849130001, 1.3071568949, 0.5030935128, 1.2014756624, 0.939644545,
            0.6031173323, 0.1623175183, 1.3093043462, 0.782458769, 1.1627983468, 0.794601962, 0.8366756894, 1.2795621026, 0.8324033815, 0.57359385,
            1.0025986594, 0.0649353769, 1.4303130495, 0.6272708804, 1.2020806017, 0.6425623671, 0.1140513152, 0.0886013632, 1.0191308115, 0.5562708665,
            1.3781603899, 0.0846762147, 0.6211326795, 0.5314866842, 0.3214885157, 0.009618815, 0.8743317776, 0.2079781514, 0.574330959, 1.3624038488,
            1.0849422409, 0.7293928703, 0.4495621812, 1.033397996, 0.9758494671, 1.1476741351, 1.2867387016, 0.8030666064, 1.0980109276, 0.6298348565,
            0.0184622358, 0.0589595401, 0.1405581988, 0.0856720814, 0.1136863675, 1.0955820423, -1.3174762725, 0.4289289627, 1.3476630623, 0.4781190122,
            0.8996445042, 1.1814111914, 1.0681003868, 0.1364253514, 0.073719621, 0.9816118035, 0.7853548438, 0.1938442307, 0.678237874, 1.3482958262,
            1.0861509396, 1.1062367866, 0.2922686802, 0.1466993458, 0.1722580431, 0.5970989443, 0.2229605455, 1.1480328181, 0.5917040799, 1.0153406074,
            0.910326594, 0.6232080622, 0.6591145717, 1.5031161302, 0.5612817514, 1.0789931181, 1.4248602456, 0.4600238743, 1.2180909341, 1.364906373,
            0.3307949634, 0.334949636, 0.9699843413, 0.8850836852, 0.1713126324, 1.5004775787, 1.1517969824, 0.9703398792, 0.8393446794, 0.6149064842,
            0.2261772899, 0.2376288345, 0.4240313227, 0.9274740237, 0.8105455217, 1.0079937922, 1.4158797127, 0.4336236911, 0.7688371553, 1.0323669377,
            1.3725506871, 0.3307602666, 0.1939228901, 0.6375471036, 1.3363492911, 1.4819942035, 0.6599315159, 1.3397931337, -1.5036313951, 0.5137994218,
            0.8669645161, 1.4764299066, 0.5487148612, 1.0014378593, 0.9392848191, 0.1470188447, 1.0710240113, 1.2492141695, 1.0551373569, 1.223313945,
            0.6404985864, 0.435138101, 0.41291491, 0.6618515571, 0.2316311214, 1.2113070015, 0.2369016304, 0.2786450955, 1.1451483095, 1.4500090187,
            0.1781023906, 0.3277178612, 0.6804363052, 0.2337748796, 0.9573148602, 0.6296918571, 0.1687552732, 1.19257776, 1.2625602483, -0.2869316423,
            1.2629957144, 0.8279120978, 0.4991173197, 0.832467232, 1.1381563213, 0.5315758478, 0.2965858691, 0.9402772998, 1.0728415425, 0.2277766084,
            0.1944200688, 0.370915448, 0.6390380565, 0.1141364761, 0.6084805219, 0.3509690341, 0.5002705334, 0.8871608196, 0.0706290601, 1.3530267743,
            0.716418933, 0.2559188405, 0.579089418, 0.8523728664, 0.575411855, 1.2169806528, 1.3228278864, 0.4165206281, 0.1983764297, 1.4114928527,
            1.3413803924, 1.2220151421, 0.7059599605, 1.29050666, 0.1789473652, 0.3751042067, 0.1011258881, 0.837554242, 1.1703388084, 0.8631355551,
            1.3346195619, 1.1777463135, 0.9408431523, 0.4650296491, 1.107439895, 1.0913691308, 0.8563126896, 0.3223352571, 0.2790095493, 0.1819101189,
            0.7780622751, 0.0138544783, 0.2103375373, 1.0342115982, 1.1305115712, 1.0367118893, 0.6167118132, 1.0937610251, 0.5119110863, 0.8456202439,
            0.0386355077, -1.357949016, 0.1260482992, 0.3954532163, 1.4938317705, 1.2822895319, 0.7691895363, 0.1613254012, 0.9200024229, 0.0973820883,
            0.9840374177, 1.2540605626, 1.0573959675, 1.1920049187, 0.7069156437, 0.7802503381, 0.5357470982, 1.3116443972, 1.4259533724, 0.9966262237,
            0.2743331911, 0.7276455302, 0.2587490269, 1.0031495465, 0.7008447142, 0.5790946096, 1.4478505971, 1.2037718816, 1.3127622185, 1.24727464,
            1.1850018392, 0.8088222066, 0.1980912518, 0.4410658164, 1.5295426549, 0.818034235, 0.0193613331, 0.2327429248, 1.2669984664, 0.072490835,
            1.1173241065, 1.325784919, 0.9833267656, 1.2089812308, 1.3935022164, 1.2692176129, 0.077072192, 0.110186113, 1.4617385981, 0.9015220957,
            1.158748146, 0.342441317, 0.3986757703, 0.4505911578, 0.4211001823, -0.432156423, 1.0301315717, 0.7387261225, 0.5752740574, 0.3542877753,
            1.0474119832, 1.1935293699, 0.4785758229, 1.0848684472, 1.5961084439, 0.9205551633, 0.1568518986, 0.6189258482, 0.6784273058, 0.4141946504,
            0.7550062257, 0.9929862335, 1.099867868, 0.6167689096, 1.534087604, 1.0549666003, 0.1257620803, 1.3481175483, -1.3002164503, 1.2976651651,
            0.3094904012, 1.1806312874, 0.0796889559, 1.3171088677, 0.5162739174, 0.5298847741, 0.5999074183, 1.0817478057, 0.1989426819, 0.8984460982,
            1.2797331065, 0.629619672, 0.6935696545, 0.3610788, 0.0812508192, 1.2123294815, 0.9770036084, 0.3430762655, 1.2122050958, 0.1571870818,
            1.5046407532, -0.2448257387, 1.0091302723, 0.6485377939, 1.0373001159, 0.1077665036, 1.4040802513, 0.4130315194, 0.7170422386, 1.3574238382,
            0.4729168766, 0.5303797413, 1.0444240234, 0.8842505525, 1.2894982021, 1.3192850035, 0.32651778, 0.144718986, 0.5105012476, 0.990983329,
            0.8048806098, 1.5510339257, 0.1397220705, 1.5046921741, 0.4847111661, 1.459367983, 1.3210170234, 0.5540841355, 1.4911428194, 1.1506654662,
            1.5264802755, 0.3694743741, 1.5775115679, 1.1331960442, 0.6397248148, 0.2167888424, 0.050528051, 1.2389222183, 0.7162677368, 0.3194449034,
            1.3610404288, 0.7996818689, 1.1197658767, 0.0195590959, 0.6226757359, 0.5951493399, 1.1643876633, 0.4370157826, 0.4151016323, 0.6064446747,
            0.194868005, 0.8248843568, 1.2011662481, 0.8365874891, 0.471664512, 1.0979640102, 0.8287139819, 0.8178590789, 1.0342247507, 1.557688128,
            0.7888996238, 1.0363576452, 0.9599791701, 0.0462412983, 1.2148225543, 0.4161283158, 0.2718583276, 0.5437681222, 0.8064127899, 0.7049694559,
            -0.746643728, 0.440215187, 0.6475603259, 0.8264708166, 0.1090557621, 0.1866842623, 1.065906505, 1.4905271556, 0.0937841392, 0.6674461832,
            1.1514494432, 0.4236505481, 1.2892230977, 1.5594880761, 0.8366715308, 1.6294577808, 0.8416360365, 0.237216291, 1.4977522049, 0.2010092918,
            0.8497729106, 0.4072114136, 1.2295179733, -0.1276777712, 0.3869710988, 0.7227694627, 1.6167730164, 0.539996462, 0.9894387754, 1.3667506506,
            0.6341248889, 1.3463522514, 1.2266269391, 0.7961164462, 1.3939522971, 0.4739851916, 1.4825157471, 0.6225452011, 1.4968202473, 1.6286597401,
            0.6691319434, 1.140747245, 0.903049735, 1.4442772096, 0.7701933813, 0.3756012088, -0.7039789114, 1.3907555004, 0.7095982414, 1.1207024647,
            1.367895708, 1.6140437071, 0.2203868957, 1.2590910006, 0.4868217485, 0.7984445606, 0.0887539962, 0.5402464468, 0.01643745, 1.5298775728,
            1.5537889113, 0.9456349663, 1.0247555815, 0.571923068, 1.2238424487, 0.6280967207, 0.17846627, 1.4774690066, 0.9149168051, 1.1278055316,
            0.3876020988, 0.8143979933, 1.3790106199, 0.4227473512, 1.1945758007, 0.6996429021, 1.4501880052, 0.2988389064, 0.0873665788, 0.4041135616,
            1.5799481562, 1.4846136676, 0.1091744985, 0.8831775701, 1.3008835308, 1.4732913355, 0.5381800214, 1.1945282002, 0.1892991718, 1.5878976262,
            1.5794132395, 0.3886684866, 1.27556197, 1.0050390303, 1.1987730317, 0.4330307165, 0.5624389959, 0.9393375993, 0.1590620147, 0.4216294709,
            0.6009981195, 0.221936692, 1.4850075582, 0.9709820261, 0.5171724797, 0.7597085499, 0.837052518, 0.6317255974, 0.0043456967, 0.6393742029,
            1.5396874742, 0.6155632422, 0.3902481798, 0.617530965, 0.3210074799, 0.2318119967, 1.1624155961, 0.1299221259, 0.7213171878, 0.8176535587,
            1.4994129703, 1.312963087, 0.6647081448, 1.5286259046, 1.2394400849, 0.6464423808, 0.2523312374, 0.1313862445, 1.5536585047, 0.9095620555,
            1.4237954739, 0.9083736396, 0.0399025114, 0.5940037973, 0.5351625277, 0.384103291, 0.499097159, 1.3333251724, 0.8722563315, 0.120155204,
            1.5510736754, 0.9127419645, 0.3937050911, 1.6137926555, 1.2832121685, 0.8811931571, 1.3549815599, 1.2482700129, 0.7559046016, 0.4181039755,
            1.0040432592, 1.4572249474, 0.2331465607, 0.6798631568, 0.0776902592, 1.4663486291, 1.2722820235, 0.4732484253, 1.3461631266, 0.3739158857,
            1.3698252737, -1.0941807905, 1.5541252779, 1.6220538677, 0.3006665842, 0.2592754738, 0.1960220573, 1.4270211871, 1.1485925081, 0.0878786885,
            1.4095514591, 0.624327515, 0.3256924329, 0.2669576981, 0.4770620082, 0.287056412, 0.0080659191, 1.4694449844, 0.0824163836, 0.9165420157,
            1.2114533545, 0.9948809326, 0.7602991356, 0.7504627681, 0.8741874586, 1.299410557, 1.3183451939, 0.0713512136, 0.2717430713, 0.5880945918,
            1.5963853272, 1.5998617238, 1.1609727987, 1.4553664523, 1.4989373995, 1.1439022231, 0.5258910961, 0.4620884549, 0.8473381861, 0.7194570738,
            1.563248178, 0.8681115068, 1.3696712516, 1.2955645575, 1.6142771515, 0.586287893, 1.6161666252, 0.5808558276, 1.4117685433, 0.7460386152,
            0.2407820344, 0.3122071917, 0.5462747714, 0.8251867325, 1.2228531914, 0.5202949716, 1.437202587, 1.3324718254, 0.140251744, 0.784684307,
            0.4486806867, 0.6327466003, 0.3485593809, 0.9823326251, 0.8733826101, 0.6705804788, 0.4186163337, 1.5409143882, 1.3801973745, 1.2426784926,
            -0.248056214, 0.9378788704, 0.7543390124, 1.356811039, 1.2973583485, 1.0340604718, 1.6102687773, 0.1991338836, 1.5782435544, 1.4600928365,
            1.389271905, 0.625018523, 0.9457596099, 0.0206928124, 0.5855410439, 1.1621940661, 0.1741787228, 0.8151608714, 0.1495956037, 1.6065491898,
            0.492813267, 1.4416688123, 0.1179388691, 1.5930285005, 1.3240004753, 1.2768414765, 1.0129087138, 0.6826150371, 0.7420362416, 0.9247799391,
            0.7368644453, 0.3536532897, 0.1611099918, 0.15736151, 0.3293121461, 1.0297167926, 0.9106140937, 0.954344219, 0.3609458878, 1.0669699184,
            0.0559682291, 1.5722351469, 0.2895741454, 1.5552207135, 0.3184238311, 0.4580813212, -1.1610482637, 1.3999115389, 0.1183855769, 0.8936005602,
            0.670992957, 0.7024083092, 1.0928638222, 0.2097511524, 0.3128098855, 1.5072225433, 0.4679984851, 0.4695537356, 1.5486845703, 1.0886173796,
            0.5595315222, 1.1259342671, 1.2114531255, 0.7553183714, 1.0746959273, 1.2107707372, 1.0465224743, 1.3486085193, 1.6149215028, 0.8043567378,
            0.4158085015, 0.0411263187, 1.4265511474, 0.0257224761, 0.3896174938, 1.1814223154, 1.1550092099, 1.5790848241, 1.6036486894, 0.2364990872,
            0.5209968208, 0.6173609364, 1.1495985666, 0.2536265628, 0.3795300222, 0.3008084382, 0.3695420353, 0.4923008177, 0.3516311536, 1.4428584241,
            1.2253466601, 1.4335794037, -0.1880864566, 1.0695225649, 0.1292079885, 0.5447804907, 0.1308882611, 0.2135899044, 1.4125517071, 1.4607092967,
            0.2238955163, 0.2070481234, 0.9812773057, 0.136895616, 1.5786666949, 0.7968465536, 0.5085689835, 1.5843447698, 0.6645212344, 1.3594689973,
            0.1376773405, 0.5142345618, 0.2616453037, 0.6189514136, 1.4273814564, 0.6279096419, 0.2435426903, 0.3853656772, 0.4566330405, 0.2911669075,
            0.4710854491, 0.8065828983, 0.55190941, 0.4842626809, 0.095849316, 0.3642836546, 1.1438496711, 1.2683070849, 0.0276733519, 0.008271789,
            1.590246221, 0.8428744791, 1.0631887705, 1.530987322, 0.6542453409, 0.9732820038, 1.2929742789, 0.2433063374, 0.0664416056, 0.5885011848,
            0.2236708971, 1.2232624254, 1.3834379147, 1.3954595682, 0.4952869979, 1.2436492428, 0.6161031263, 1.6191284143, 0.3606620158, 0.1219344048,
            1.2445060734, 0.065191572, 1.028034148, 1.0146647664, 0.2969551733, 0.8138422104, 1.4323053045, 0.0318163563, 0.1198086973, 0.3015303853,
            0.3773757133, 0.0359742429, 1.17900265, 0.7202300405, 0.7037719829, 0.1036907425, 0.5641468527, 1.0597379487, 0.4223495579, 1.0592057332,
            1.6264385588, 1.453300157, 0.8337208989, 0.4400127572, 0.5188094929, 0.751445321, 1.3856623712, 0.2659545167, 1.6181303059, 0.2127007906,
            1.1039553838, 1.1926666865, 0.7155679582, 0.7968231711, 0.6462653856, 0.0134000977, 0.3923412832, 0.7225292113, 1.3139979441, 0.3762282246,
            0.8361857081, 1.6129078224, 1.1806464032, 1.4123009899, 0.6717046924, 0.9911261669, 0.882873624, 0.5649711623, 1.387273763, 0.4914176534,
            0.6509686852, 0.4934930493, 0.683059911, 0.0957251789, 0.6199160935, 0.7349624111, 0.8796960302, -0.4695478039, 0.8813417333, 0.8189649457,
            1.3491599686, 1.3767217574, 0.3283235764, 0.5771897131, 1.1871873377, 0.0187634056, 0.649064151, 0.9070148294, 0.879490713, 1.2733154846,
            0.5203126005, 0.8963681864, 0.0519518462, 0.79062368, 0.172699518, 0.7508799623, 0.0520425293, 0.828742185, 0.5905626119, 0.4592612812,
            0.8217520388, 0.7848127433, 0.4915732685, 0.2197905988, 1.0347120597, 0.5006736251, 0.9097666299, 1.5033382172, 0.8635521786, 0.3783786246,
            0.4365563049, 0.1234613362, 0.9782672989, 1.4154308771, 0.3679465973, 0.5756294516, 0.4025179534, 0.0241976526, 0.9007925207, 0.7888790267,
            1.6301326649, 0.6636970312, 0.9145169147, -0.0948486249, 0.7588080381, 1.5252844704, 0.3824690405, 1.5770979408, 1.0684831914, 1.325275221,
            0.0033182869, 0.4628957621, 0.9625813296, 0.2197034689, 0.4956553433, 0.2740691969, 1.0614076965, 1.126602721, 1.281377498, 0.3353593711,
            0.8502325496, 0.8148720559, 1.3361426404, 1.5024504096, 0.2357985067, 0.8444073281, -0.4209146928, 1.265411681, 1.0045774685, 0.1448699282,
            1.3131417022, 1.2241121901, 0.8414926236, 0.4443849759, 0.6963489323, 0.4000166788, 1.3315534958, 1.4538546354, 0.1255427324, 1.4171353559,
            0.1123545944, 0.3743100142, 1.5579828032, 0.3133050676, 0.5266608176, 1.0280967511, 0.7018230615, 1.5711756004, 1.363129329, -0.1627839732,
            1.5565638218, 0.4860308678, 0.726954136, 1.1582984143, 1.429004097, 0.6591492597, 0.300116705, 1.1112653254, 1.0351410351, 1.536915921,
            0.810037188, 0.8761450816, 1.4518518582, 1.1659653407, 0.4762680119, 0.7080627212, 1.5015919538, 0.9183270901, 1.427642568, 1.2890492717,
            1.3803524692, 0.6272746472, 1.0229303731, 0.9221181311, 1.5092612251, 0.6120054467, 0.447795552, 1.4389813905, 1.4787056399, 1.3851020589,
            0.9754494256, 1.1973592304, 0.8230154735, 0.2025982762, 0.5022149381, 0.3933384452, 0.6486360893, 0.9550443511, 1.3388779154, 1.6109012315,
            0.7488976926, 0.8775100615, 1.0220238029, 0.8076971003, 0.6642679561, -0.0100235663, 0.4377110749, 0.5119868329, 1.5501811175, 0.939332043,
            0.9360935357, 1.1444921031, 0.6171628371, 1.5931966058, 0.6682658652, 1.2253543695, 0.8116985539, 0.3916110419, 0.0886697796, 1.3537854758,
            1.5504187424, 0.8537248574, 0.5497401287, 0.429975085, 1.1596298437, 0.8644205676, 0.6737272396, 0.4589756983, -1.4880438963, 0.0075059234,
            1.4945092477, 0.1519187455, 0.3692047821, 0.1290059564, 0.6630264021, 0.8170932724, 0.8142519815, 0.6273288852, 1.0871497452, 1.5370039372,
            0.4205287754, 1.4987445173, 1.3880540194, 1.5886148529, 1.568500639, 1.2884191479, 0.067345632, 0.196976168, 1.5730981659, 0.813553698,
            0.2806881273, 0.4467345557, 0.8073588454, 0.1644634191, 0.6676845187, 0.1033713596, 1.1016986024, 1.1120369382, 1.4055152153, 0.0678158657,
            1.0555873236, 1.3732155008, 0.1392180294, 0.5695393253, 0.6272605768, 0.7709857367, 1.0935108128, 0.6001759956, 0.1168729746, 0.054153855,
            1.4235685419, 1.4908418336, 0.5999744768, 1.1885479623, 1.2126854032, 0.873043648, 0.2193893404, 0.5118587091, 0.4966818102, 1.5233969497,
            1.1745615596, 1.5417715822, 0.1844152919, 1.0034581885, 0.6978759106, 1.3221878659, 0.5388640287, 1.3419526422, 0.1189417899, 0.1101674422,
            0.6750366842, 0.3437726164, 0.5010961661, 0.9293235186, 0.3722647569, 0.3523914976, 1.357023275, 1.2886259425, 1.1864268148, 1.5916866014,
            0.1589211123, 0.3273526123, 0.0700806987, 1.416237369, 1.4245736233, 0.6416719579, 1.5148495108, 1.3405622315, 1.3020415154, 0.7683344872,
            0.9856904, 1.4899189081, 0.4683294512, 1.3626287272, 1.2869833387, 1.5658912389, 0.618918126, 1.2863761033, 0.4094120818, 1.2648664662,
            0.6172906594, 1.4110464219, 1.6000023211, 1.2205646442, 1.3164473669, 1.2300314771, 0.797677136, 1.2384512124, 0.2252057152, 1.4941809304,
            1.1476708805, 0.0180257701, 1.1059434707, 0.5086062415, 0.7528799856, 0.3843279881, 0.403390254, 0.5807376594, 0.936675783, 0.1606225678,
            1.5320033156, 0.3278974171, 1.3938268674, 0.4674583603, 1.4632667925, 0.867612277, 1.4875704866, 0.2292326536, 0.0826443944, 1.1489281746,
            0.9342156917, 0.3764019088, 0.5848812737, 1.2370930214, 0.9853821811, 0.0209089232, 1.0367258188, 1.4508037421, 0.6363225272, 0.594221841,
            0.285310213, 0.7101588558, 0.0253473293, 0.0778727273, 0.8478715049, 1.2816112721, 0.5968227677, 1.4752573601, 0.0676357329, 1.5804699273,
            1.2789280347, 0.9994716309, 0.9384205085, 0.4833593857, 1.2792902279, 0.8982528314, 0.5795706477, 0.7052523765, 0.8640199971, 1.5867512847,
            1.2858346865, 1.2140520238, 1.3407233491, 0.6920347472, 1.2558233125, 1.3342568255, 0.8298958413, 0.1056626316, 1.0904245164, -0.4181945571,
            0.4072030109, 0.9198215835, 0.2113517424, 0.9235606911, 0.0665947722, 0.1353411652, 0.9922144441, 0.233364266, 1.3785486231, 0.4384689164,
            0.7218789405, 1.0105239937, 0.2996659315, 0.3140068096, 0.0963758515, 0.9322775912, 0.7817169364, 0.969707506, 0.0293857936, 0.2358399266,
            1.3974901747, 0.8671614346, -0.3613676, 1.3145229449, 1.2179341732, 1.0448874874, 1.0607698538, 1.2826678644, 0.9009984169, 0.5914613345,
            1.0107977628, 1.2827783602, 1.4003564005, 0.4225674726, 1.0462970898, 0.0691532525, 0.1988674395, 0.2614269346, 0.3705152907, 0.4277795062,
            0.2417672965, 0.5348663094, 0.0428217569, 0.0482605319, 0.8397717062, -0.0036804051, 0.9844082123, 0.3953123011, 0.2964811571, 1.4220181011,
            0.2659163145, 1.4225176656, 0.655134806, 1.344620344, 1.0211261561, 1.5307409204, 1.0969936131, 0.8509459518, 1.3728789169, 0.8772354071,
            1.3798156056, 0.9718813925, 1.1059707424, 0.6045800082, 0.7189798999, 0.1052751585, 0.4637673351, 0.7811500804, 1.2661889608, 0.511102704,
            0.2259481979, 0.0478022961, 0.1431626192, 0.3915111246, 1.136831632, 1.4271682211, 0.7797498719, 0.0738091134, 0.1888704283, 0.8597662612,
            0.5517926829, 1.5991661363, 0.8912947886, 0.2356349352, 0.3763079933, 1.538879076, 1.020386659, 0.0902020403, 0.2122031561, 1.0546906678,
            0.6880529521, 0.7735233706, 1.0753013038, 1.3078250855, 0.6982720749, 1.3099559671, 1.2250780825, 1.5902060208, 0.322073, 0.3877732103,
            1.5580647286, 1.2144024482, 0.1365624994, 0.1634306062, 1.3716548966, 1.593420255, 0.0547783553, 1.1433166299, 1.1224343211, 0.7891764677,
            0.2341953679, 0.947579369, 1.4774011151, 1.333197421, 0.9885142097, 1.016585488, 0.9608406835, 0.5413414102, 0.7623016351, 1.3369191648,
            1.1095953518, 0.6439502995, 0.0642846516, 0.2496341796, 0.8747683092, 1.2095115416, 1.5999395743, 0.3938247755, 0.9424149724, 0.5122365393,
            0.1203208224, 0.6429146304, 0.2934298877, 0.4479202083, 0.7860920799, 0.0129999971, 1.5244751593, -0.8990779333, 1.0999298303, 1.5101011106,
            1.588959255, 0.0956043621, 0.370466047, 0.9644639091, 1.4760980286, 0.9835578919, 0.894990118, 0.6317990013, 1.1936903093, 0.5215372255,
            0.8357844714, 1.5469548211, 0.1575803646, 0.0123206104, 0.9078416199, 0.3654804112, 1.1524501108, 0.8324577837, 0.7132812025, 0.8216859628,
            -0.4787058524, 1.2603195568, 0.5244689818, 0.1374858912, 0.0307685324, 1.5762577607, 0.6927954717, 0.7432253185, 0.7199371402, 0.1960379718,
            0.3148093523, 0.4479077968, 1.4511034867, 0.5318177029, 0.6533183427, 0.2958786458, 0.3204007872, 0.268035327, 0.9762450248, 0.419791333,
            1.5947724627, 1.5804343092, 0.9993278811, -0.4404427317, 1.0170762386, 1.5019976269, 1.5510572799, 0.32833753, 1.19205222, 0.665065556,
            0.7567441536, 1.0710342969, 0.2122758662, 1.5090984816, 0.8514137246, 0.0030998797, 0.9213495327, 0.2507764842, 1.3970528233, 1.4960818672,
            0.7682400759, 0.9063545836, 1.594687066, 0.5108790544, 0.7664323694, 0.9862893865, 0.2404504144, 0.0393765793, 0.8408422108, 0.7188829506,
            1.0427802308, 0.8179027135, 0.1156309488, 0.2289321764, 0.7364249077, 1.5079515222, 1.1241757664, 0.6822578393, 0.6776867587, 0.8669759647,
            0.6232931401, 0.1078146998, 0.4482879924, 1.1874898374, 1.1150620702, 1.3211972862, 0.1782567515, 0.3514001121, 1.3670403483, 1.5749406874,
            0.1622266251, 0.7320592951, 1.5226854672, 0.1940710179, 0.9800335011, 0.5933661735, 0.4050463223, 0.3114079131, 0.984241411, 1.2061749133,
            1.3499076902, 0.4857816319, 1.6006449919, 1.2254094555, 1.1284407475, 1.1586882701, 0.2137871934, 0.6253947818, 1.1322970232, 0.587421851,
            1.1510610704, 1.4994183063, 0.0140084303, 1.2888294717, 1.2034741748, 1.1877670398, 0.0558280407, 1.3739653165, 0.4655631778, 0.3385709807,
            0.765941149, 0.8745789712, 0.8014299897, 1.1785976715, 0.8560757543, 0.6239897868, 0.3532230713, 0.9287152327, 0.8679351594, 1.3404429855,
            0.8050815169, 0.1031393187, 1.3583044653, 0.8199430768, 0.0988686844, 0.9112956358, 0.6499313656, 0.4142892104, 0.0311699887, 0.8912254134,
            0.2564055243, 0.5785468853, 1.3555043599, 0.8995483191, 1.2925050081, 0.3927087632, 1.3468188705, 1.4766335211, 0.0180643393, 1.5890201566,
            0.4162657885, 0.243838454, 1.0496257247, 0.473929314, 0.7392157538, 0.6805946904, 1.4846781385, 0.503120891, -1.0723249052
    };

    public static MLMethod createNetwork() {
        MLMethodFactory methodFactory = new MLMethodFactory();
        MLMethod result = methodFactory.create("feedforward", "22:B->SIGMOID->22:B->SIGMOID->30:B->SIGMOID->10:B->SIGMOID->3", 22, 3);
        ((MLEncodable) result).decodeFromArray(WEIGHTS);
        return result;
    }


    final BasicNetwork myNeuralNetwork;
    final IPlayerStatisticsHolder statsHolder;

    @Inject
    public NeuralNetworkPlayerModel(IPlayerStatisticsHolder statsHolder) {
        myNeuralNetwork = (BasicNetwork)createNetwork();
        this.statsHolder = statsHolder;
    }

    @Override
    public ProbabilityTriple calculateActionProbabilties(IGameState state) {


        // features:
        // vpip, pfr, street, potOdds, hasRaisedPreFlop, preflopRaises, percentStackCommited, scaledStackSize, myAggressionCount,
        // nOppAggressors, playerHasChecked, distanceToButton, nActivePlayers, gameIsOpen,
        // aceCount, kingCount, queenCount, jackCount, nPairs, nTrips, nFours, maxSuitCount
        //

        IPlayerState playerState = state.nextPlayer();
        int nextSeat = state.nextPlayerSeat();

        IPlayerStatistics playerStats = statsHolder.get(playerState.id());

        if (playerState.id() != playerStats.id()) {
            log.error(String.format("Incorrect player statistics"));
            throw new RuntimeException("Incorrect player statistics");
        }

        double hasRaisePreFlop = playerStats.hasRaisedPreFlopThisRound() ? 1.0 : 0.0 ;
        double hasChecked = playerState.hasChecked() ? 1.0 : 0.0 ;

        double percentStackCommitted = playerState.pot().toDouble() / (playerState.bank().toDouble() + playerState.pot().toDouble());
        double scaledStackSize = Math.tanh(playerState.bank().toDouble() / state.bigBlind().toDouble() / 1000.0);

        int nActivePlayers = state.playersStillIn().size();
        int distanceToButton =  (state.dealerPosition() - nextSeat) % nActivePlayers;

        int gameIsOpen = state.hasBets() ? 0 : 1;

        ImmutableList<Card> boardCards = state.communityCards();

        int aceCount = FluentIterable.from(boardCards).filter(card -> card.rank() == Rank.ACE).size();
        int kingCount = FluentIterable.from(boardCards).filter(card -> card.rank() == Rank.KING).size();
        int queenCount = FluentIterable.from(boardCards).filter(card -> card.rank() == Rank.QUEEN).size();
        int jackCount = FluentIterable.from(boardCards).filter(card -> card.rank() == Rank.JACK).size();

        ImmutableList<Rank> ranks = FluentIterable.from(boardCards).transform(card -> card.rank()).toList();
        ImmutableList<Suit> suits = FluentIterable.from(boardCards).transform(card -> card.suit()).toList();
        ImmutableMap<Rank, Integer> rankCounts = FluentIterable.from(ranks).toMap(rank -> Collections.frequency(ranks, rank));
        ImmutableMap<Suit, Integer> suitCounts = FluentIterable.from(suits).toMap(suit -> Collections.frequency(suits, suit));

        int nPairs = FluentIterable.from(rankCounts.entrySet()).filter(rankCount -> rankCount.getValue() == 2).size();
        int nTrips = FluentIterable.from(rankCounts.entrySet()).filter(rankCount -> rankCount.getValue() == 3).size();
        int nFours = FluentIterable.from(rankCounts.entrySet()).filter(rankCount -> rankCount.getValue() == 4).size();
        int maxSuitCount = 0;
        if(suitCounts.size() > 0) {
            maxSuitCount = Collections.max(suitCounts.values());
        }

        if(nPairs > 0 || nTrips > 0 || nFours > 0 || aceCount > 0 || kingCount > 0 || queenCount >0 || jackCount > 0 ){
            int i = 0;
        }

        ImmutableList<Integer> aggrestionsThisStreet =
        FluentIterable.from(statsHolder.getAll().entrySet())
                      .filter(entry -> entry.getValue().id() != playerStats.id())
                      .transform(entry -> entry.getValue().aggressionCountThisStreet()).toList();

        Integer totalOppAggresions = 0;
        for(Integer aggThisStree : aggrestionsThisStreet) {
            totalOppAggresions += aggThisStree;
        }



        // features:
        // vpip, pfr, street, potOdds, hasRaisedPreFlop, preflopRaises, percentStackCommited, scaledStackSize, myAggressionCount,
        // nOppAggressors, playerHasChecked, distanceToButton, nActivePlayers, gameIsOpen,
        // aceCount, kingCount, queenCount, jackCount, nPairs, nTrips, nFours, maxSuitCount
        //


        double[] inputArray = {playerStats.vpip(), playerStats.pfr(), state.street().ordinal(), state.potOdds(),
                hasRaisePreFlop, playerStats.preFlopRaisesThisRound(), percentStackCommitted,
                scaledStackSize, playerStats.aggressionCountThisStreet(),totalOppAggresions,
                hasChecked,distanceToButton , nActivePlayers, gameIsOpen,
            aceCount, kingCount, queenCount, jackCount, nPairs, nTrips, nFours, maxSuitCount};

        MLData inputs = new BasicMLData(inputArray);


        MLData outputs = myNeuralNetwork.compute(inputs);

        // renormalise

        double norm = outputs.getData(0) + outputs.getData(1) + outputs.getData(2);

        double call = outputs.getData(0) / norm;
        double fold = outputs.getData(1) / norm;
        double raise = outputs.getData(2) / norm;

        return new ProbabilityTriple(fold, call, raise);
    }
}
